<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dettaglio Ricetta - Recipe Browser</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <h1 id="recipeTitle">◐ Dettaglio Ricetta</h1>
        <p id="recipeSubtitle">Tutti i dettagli per preparare questo piatto</p>
    </header>

    <nav class="nav">
        <div class="nav-container">
            <a href="index.html" class="nav-link">⌂ Home</a>
            <a href="categories.html" class="nav-link">⊞ Categorie</a>
            <a href="search.html" class="nav-link">⊙ Cerca</a>
            <a href="random.html" class="nav-link">⊛ Casuale</a>
        </div>
    </nav>

    <div class="container">
        <div id="recipeContainer">
            <div class="loading">Caricamento ricetta...</div>
        </div>
        
        <!-- Pulsanti azione -->
        <div id="actionButtons" style="display: none; text-align: center; margin: 2rem 0;">
            <button onclick="window.history.back()" class="btn btn-secondary" style="margin-right: 1rem;">
                ◀ Indietro
            </button>
            <button onclick="getAnotherRandom()" class="btn">
                ⊛ Altra Ricetta Casuale
            </button>
            <button onclick="searchSimilar()" class="btn btn-secondary" style="margin-left: 1rem;">
                ⊙ Ricette Simili
            </button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://www.themealdb.com/api/json/v1/1/';
        let currentRecipe = null;

        // Ottieni l'ID della ricetta dall'URL
        function getRecipeIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Carica i dettagli della ricetta
        async function loadRecipeDetails(recipeId) {
            const container = document.getElementById('recipeContainer');
            const actionButtons = document.getElementById('actionButtons');
            
            try {
                const response = await fetch(`${API_BASE}lookup.php?i=${recipeId}`);
                const data = await response.json();
                
                if (data.meals && data.meals[0]) {
                    const recipe = data.meals[0];
                    currentRecipe = recipe;
                    
                    // Aggiorna i titoli
                    document.getElementById('recipeTitle').textContent = recipe.strMeal;
                    document.getElementById('recipeSubtitle').textContent = `${recipe.strCategory} • ${recipe.strArea}`;
                    document.title = `${recipe.strMeal} - Recipe Browser`;
                    
                    // Prepara gli ingredienti
                    const ingredients = [];
                    for (let i = 1; i <= 20; i++) {
                        const ingredient = recipe[`strIngredient${i}`];
                        const measure = recipe[`strMeasure${i}`];
                        
                        if (ingredient && ingredient.trim()) {
                            ingredients.push({
                                name: ingredient.trim(),
                                measure: measure ? measure.trim() : '',
                                image: `https://www.themealdb.com/images/ingredients/${ingredient.trim().replace(/\s+/g, '_').toLowerCase()}-small.png`
                            });
                        }
                    }
                    
                    // Renderizza la ricetta
                    container.innerHTML = `
                        <div class="recipe-detail">
                            <div class="recipe-header">
                                <img src="${recipe.strMealThumb}" alt="${recipe.strMeal}" class="recipe-header-image">
                                <h1 class="recipe-title">${recipe.strMeal}</h1>
                            </div>
                            
                            <div class="recipe-content">
                                <div class="recipe-meta">
                                    <div class="meta-item">
                                        <span class="meta-label">Categoria:</span>
                                        <span class="meta-value">${recipe.strCategory}</span>
                                    </div>
                                    <div class="meta-item">
                                        <span class="meta-label">Origine:</span>
                                        <span class="meta-value">${recipe.strArea}</span>
                                    </div>
                                    ${recipe.strTags ? `
                                        <div class="meta-item">
                                            <span class="meta-label">Tags:</span>
                                            <span class="meta-value">${recipe.strTags}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div class="ingredients-section">
                                    <h2 class="section-title">◎ Ingredienti</h2>
                                    <div class="ingredients-list">
                                        ${ingredients.map(ingredient => `
                                            <div class="ingredient-item">
                                                <img src="${ingredient.image}" alt="${ingredient.name}" 
                                                     class="ingredient-image" 
                                                     onerror="this.src='data:image/svg+xml,<svg xmlns=\\"http://www.w3.org/2000/svg\\" viewBox=\\"0 0 50 50\\"><rect width=\\"50\\" height=\\"50\\" fill=\\"%23ffa07a\\"/><text x=\\"25\\" y=\\"30\\" text-anchor=\\"middle\\" fill=\\"white\\" font-size=\\"20\\">◎</text></svg>'">>
                                                <div class="ingredient-text">
                                                    <div class="ingredient-name">${ingredient.name}</div>
                                                    <div class="ingredient-measure">${ingredient.measure}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="instructions-section">
                                    <h2 class="section-title">◐ Istruzioni</h2>
                                    <div class="instructions-text">${formatInstructions(recipe.strInstructions)}</div>
                                </div>
                                
                                ${recipe.strYoutube ? `
                                    <div class="instructions-section">
                                        <h2 class="section-title">◉ Video Tutorial</h2>
                                        <div style="text-align: center;">
                                            <a href="${recipe.strYoutube}" target="_blank" class="btn" style="display: inline-block;">
                                                ◐ Guarda su YouTube
                                            </a>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${recipe.strSource ? `
                                    <div class="instructions-section">
                                        <h2 class="section-title">◒ Fonte Originale</h2>
                                        <div style="text-align: center;">
                                            <a href="${recipe.strSource}" target="_blank" class="btn btn-secondary" style="display: inline-block;">
                                                ◎ Visita Sito Originale
                                            </a>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    
                    actionButtons.style.display = 'block';
                    
                    // Animazione fade-in
                    container.querySelector('.recipe-detail').classList.add('fade-in');
                    
                } else {
                    container.innerHTML = `
                        <div class="error">
                            ◒ Ricetta non trovata
                            <br><br>
                            <button onclick="window.location.href='index.html'" class="btn">
                                Torna alla Home
                            </button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Errore nel caricamento ricetta:', error);
                container.innerHTML = `
                    <div class="error">
                        ◒ Errore nel caricamento della ricetta. 
                        <br>Controlla la connessione internet e ricarica la pagina.
                        <br><br>
                        <button onclick="window.location.reload()" class="btn">
                            Ricarica Pagina
                        </button>
                    </div>
                `;
            }
        }

        // Formatta le istruzioni con numerazione
        function formatInstructions(instructions) {
            if (!instructions) return 'Istruzioni non disponibili.';
            
            // Dividi per frasi e aggiungi numerazione
            const sentences = instructions.split(/\.\s+/).filter(sentence => sentence.trim());
            
            if (sentences.length <= 1) {
                return instructions;
            }
            
            return sentences.map((sentence, index) => {
                const trimmed = sentence.trim();
                if (trimmed) {
                    return `${index + 1}. ${trimmed}${trimmed.endsWith('.') ? '' : '.'}`;
                }
                return '';
            }).filter(Boolean).join('\n\n');
        }

        // Ottieni un'altra ricetta casuale
        async function getAnotherRandom() {
            try {
                const response = await fetch(`${API_BASE}random.php`);
                const data = await response.json();
                
                if (data.meals && data.meals[0]) {
                    const newRecipeId = data.meals[0].idMeal;
                    window.location.href = `recipe-detail.html?id=${newRecipeId}`;
                }
            } catch (error) {
                console.error('Errore nel caricamento ricetta casuale:', error);
                alert('Errore nel caricamento di una nuova ricetta casuale.');
            }
        }

        // Cerca ricette simili
        function searchSimilar() {
            if (currentRecipe) {
                // Cerca per categoria
                window.location.href = `category-meals.html?category=${encodeURIComponent(currentRecipe.strCategory)}`;
            }
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            const recipeId = getRecipeIdFromURL();
            
            if (recipeId) {
                loadRecipeDetails(recipeId);
            } else {
                document.getElementById('recipeContainer').innerHTML = `
                    <div class="error">
                        ◒ ID ricetta non specificato. 
                        <br><br>
                        <button onclick="window.location.href='index.html'" class="btn">
                            Torna alla Home
                        </button>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
